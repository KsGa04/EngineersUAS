<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <div class="wrapper">
        <header>
            <div class="header__container _container">
                <div class="header__left">
                    <div class="header__logo">
                        <div class="logo__example"></div>
                    </div>
                    <div class="header__logo__title">
                        <h1>–ö–∞—Ä—å–µ—Ä–Ω—ã–π<br>–ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π<br>–ü–æ—Ä—Ç–∞–ª</h1>
                    </div>
                </div>
                <div class="header__right">
                    <img src="static/assets/images/person_icon.svg" alt="" id="personIcon">
                    <div class="person-menu" id="personMenu">
                        <ul>
                            <li><a href="/userboard">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></li>
                            <li><a href="/cvgenerator">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∑—é–º–µ</a></li>
                            <li><a href="/login">–í—ã—Ö–æ–¥</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>
        <main>
            <div class="account__container _container">
                <div class="account__content">
                    <!-- –°–µ–∫—Ü–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞ -->
                    <div class="contest__container">
                        <div class="contest__header">
                            <h1>üöÄ –ö–æ–Ω–∫—É—Ä—Å: "–ü—Å–∞–Ω–æ–º–∞–ª–∏—è –Ω–∞ –ú–∞—Ä—Å–µ"</h1>
                            <img src="static/images/image1.jpg" alt="–ö–æ–Ω–∫—É—Ä—Å –ü—Å–∞–Ω–æ–º–∞–ª–∏—è">
                        </div>
                        <div class="contest__content">
                            <p><strong>–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —Å–ø–æ—Å–æ–± –Ω–µ–π—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–æ–±–æ—Å–æ–±–∞–∫</strong>, –∫–æ—Ç–æ—Ä—ã–µ —É–≥—Ä–æ–∂–∞—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∫–æ–ª–æ–Ω–∏–∏ –Ω–∞ –ú–∞—Ä—Å–µ. –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –∂–¥—É—Ç:</p>
                            <ul>
                                <li>üí∞ –î–µ–Ω–µ–∂–Ω—ã–µ –ø—Ä–∏–∑—ã: –¥–æ 30 000 ‚ÇΩ</li>
                                <li>‚ú® –û–ø—ã—Ç –≤ —Ä–µ—à–µ–Ω–∏–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á</li>
                                <li>ü§ù –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ —Å –ª–∏–¥–µ—Ä–∞–º–∏ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏</li>
                            </ul>
                            <p><strong>–î–µ–¥–ª–∞–π–Ω:</strong> 15 –¥–µ–∫–∞–±—Ä—è 2024</p>
                            <p>–í–∞—à <strong>ID:</strong> <span id="userIdDisplay" class="highlight-id">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span></p>
                            <div class="button-container">
                                <button class="submit-answer-btn" onclick="location.href='https://forms.gle/AqvLVjsp2yCkRUJ99'">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
                            </div>
                        </div>
                    </div>
                    <!-- –ö–æ–Ω–µ—Ü —Å–µ–∫—Ü–∏–∏ –∫–æ–Ω–∫—É—Ä—Å–∞ -->

                    <div class="account__inner">
    <div class="account__inner__header">
        <div class="account__header__left">
            <div class="account__header__title">
                <h1>–õ–ò–ß–ù–´–ô</h1><h1>–ö–ê–ë–ò–ù–ï–¢</h1>
            </div>
        </div>
        <div class="user__avatar__wrapper">
            <div class="user__avatar">
                <img id="profilePhoto" src="static/assets/images/user__avatar.png" alt="User Avatar">
            </div>
            <div class="edit__avatar__item">
                <img src="static/assets/images/icon_edit_avatar.svg" alt="">
                <a href="javascript:void(0)">–ò–∑–º–µ–Ω–∏—Ç—å</a>
                <input type="file" id="photoInput" accept="image/*" style="display:none"/>
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏ account__inner -->
            <div class="account__inner__content">
                <!-- –§–æ—Ä–º–∞ —Å–ª–µ–≤–∞ -->
                <div class="account__cv__form__block">
                    <form action="#" class="account__cv__form">
                        <div class="cv_name_item cv__form__item">
                            <div class="cv__form__title">
                                <h4>–§–ò–û</h4>
                            </div>
                            <input type="text" class="cv__form__input small-textarea" name="cv__name" />
                        </div>
                        <div class="birthDate__item cv__form__item">
                            <div class="cv__form__title">
                                <h4>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</h4>
                            </div>
                            <input type="date" name="birth_date" class="cv__form__input small-textarea" />
                        </div>
                        <div class="university__item cv__form__item">
                            <div class="cv__form__title">
                                <h4>–û–ø–∏—Å–∞–Ω–∏–µ *</h4>
                            </div>
                            <textarea name="about_me" class="cv__form__input large-textarea"></textarea>
                        </div>
                        <div class="cv_name_item cv__form__item">
                            <div class="cv__form__title">
                                <h4>–¢–µ–ª–µ–≥—Ä–∞–º</h4>
                            </div>
                            <input type="text" class="cv__form__input small-textarea" name="network_link" />
                        </div>
                    </form>
                </div>

                <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ø—Ä–∞–≤–∞ -->
                <div class="account__cv__preview">
                    <div class="cv__preview">
                        <img src="static/assets/images/cv_preview.png" alt="">
                        <div class="cv__demo">
                            <a href="javascript:void(0)" id="previewBtn">–ü–†–ï–î–ü–†–û–°–ú–û–¢–†</a>
                        </div>
                    </div>
                    <a href="/cvgenerator" class="download__preview">–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ <br> –†–ï–ó–Æ–ú–ï</a>
                </div>
            </div>
        </div>

                    <!-- –ö–æ–Ω–µ—Ü —Å–µ–∫—Ü–∏–∏ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ -->
                </div>
            </div>
        </main>
        <div class="contacts__wrapper">
            <a href="https://t.me/KIP_support"><img src="static/assets/images/telegram.png" alt=""></a>
        </div>
    </div>
    <script src="/static/icon.js"></script>
</body>
<script>
    document.addEventListener("DOMContentLoaded", async function() {
    const userId = localStorage.getItem("user_id");
    const userIdDisplay = document.getElementById("userIdDisplay");

    if (userId) {
        userIdDisplay.textContent = userId;
    } else {
        userIdDisplay.textContent = "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
    }
    const authToken = localStorage.getItem("token");
    let resumePatternId = null;

    if (!userId) {
        alert("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ.");
        window.location.href = "/login";
        return;
    }

    try {
        console.log(`–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è user_id=${userId}`);
        const response = await fetch(`/user/${userId}`, {
            method: 'GET',
            credentials: 'include'
        });

        const userData = await response.json();
        console.log("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", userData);

        if (response.ok) {
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
            document.querySelector("[name='cv__name']").value = `${userData.last_name || ''} ${userData.first_name || ''} ${userData.middle_name || ''}`;
            document.querySelector("[name='birth_date']").value = userData.birth_date || "";
            document.querySelector("[name='about_me']").value = userData.resume.about_me || "";
            document.querySelector("[name='network_link']").value = userData.resume.telegram || "";
            const aboutMeField = document.querySelector("[name='about_me']");
            if (userData.resume.about_me) {
                aboutMeField.value = userData.resume.about_me;
                aboutMeField.disabled = false;
            } else {
                aboutMeField.value = "–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∑—é–º–µ.";
                aboutMeField.disabled = true;
            }
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            resumePatternId = userData.resume.id_pattern;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
            if (userData.profile_photo) {
                document.getElementById("profilePhoto").src = `data:image/jpeg;base64,${userData.profile_photo}`;
            }
        } else {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
        }
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É:", error);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É.");
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ "–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" –∏ "–°–∫–∞—á–∞—Ç—å"
    document.getElementById("previewBtn").addEventListener("click", function() {
        if (resumePatternId) {
            window.open(`/pattern${resumePatternId}/${userId}`, '_blank');
        } else {
            alert("–ù–µ —É–∫–∞–∑–∞–Ω —à–∞–±–ª–æ–Ω —Ä–µ–∑—é–º–µ.");
        }
    });

});

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
    document.querySelector(".edit__avatar__item a").addEventListener("click", () => {
        document.querySelector("#photoInput").click();
    });

    document.querySelector("#photoInput").addEventListener("change", async function () {
    const file = this.files[0];
    if (!file) return;
    // Check file type
    const validExtensions = ['jpg', 'jpeg', 'png'];
    const fileExtension = file.name.split('.').pop().toLowerCase();
    if (!validExtensions.includes(fileExtension)) {
        alert("Please upload an image file with a .jpg, .jpeg, or .png extension.");
        return;
    }
    const reader = new FileReader();
    reader.onload = async function () {
        const base64Image = reader.result.split(',')[1];// –ü–µ—Ä–µ–¥–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
        const userId = localStorage.getItem("user_id");
        const authToken = localStorage.getItem("authToken");

        try {
            const response = await fetch(`/api/user/${userId}/update_photo`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ profile_photo: base64Image }), // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                credentials: 'include'
            });

            if (response.ok) {
                document.querySelector(".user__avatar img").src = reader.result;
                alert("–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ.");
            } else {
                const errorData = await response.json();
                alert(errorData.msg || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è.");
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞:", error);
            alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.");
        }
    };
    reader.readAsDataURL(file); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å –ø–æ–ª–Ω—ã–º base64 –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
});

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API
async function updateDataInDB(table, fieldName, fieldValue) {
    const userId = localStorage.getItem("user_id");
    const id_resume = localStorage.getItem("id_resume");
    if (!userId) {
        console.error("User ID –Ω–µ –Ω–∞–π–¥–µ–Ω.");
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.");
        return;
    }

    try {
        if (table == "userSocialNetwork") {
            const response = await fetch(`/universal/${table}?id_resume=${id_resume}`, {
                method: 'PUT',
                headers: {
                    'Accept': '*/*',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ [fieldName]: fieldValue }),
                credentials: 'include'
            });
            if (!response.ok) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –æ—Ç–ª–æ–≤–∞ –æ—à–∏–±–æ–∫ —Å–µ—Ä–≤–µ—Ä–∞
            const result = await response.json();
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:", result);
            alert(result.msg || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.");
        } else {
            console.log("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.");
        }
            }
        else {
            const response = await fetch(`/universal/${table}?id_user=${userId}`, {
                method: 'PUT',
                headers: {
                    'Accept': '*/*',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ [fieldName]: fieldValue }),
                credentials: 'include'
            });
            if (!response.ok) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –æ—Ç–ª–æ–≤–∞ –æ—à–∏–±–æ–∫ —Å–µ—Ä–≤–µ—Ä–∞
            const result = await response.json();
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:", result);
            alert(result.msg || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.");
        } else {
            console.log("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.");
        }
            }
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É:", error);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.");
    }
}
document.querySelector("[name='cv__name']").addEventListener("change", function() {
    const fullName = this.value.trim();

    // Split the full name into parts
    const nameParts = fullName.split(' ');
    const firstName = nameParts[0] || '';
    const middleName = nameParts.length === 3 ? nameParts[1] : '';
    const lastName = nameParts.length >= 2 ? nameParts[nameParts.length - 1] : '';

    // Update each name part in the database
    updateDataInDB('user', 'last_name', firstName);
    updateDataInDB('user', 'first_name', middleName);
    updateDataInDB('user', 'middle_name', lastName);

    alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.");
});
// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö input –∏ textarea
document.querySelectorAll(".cv__form__input").forEach(input => {
    input.addEventListener("change", function() {
        const fieldName = this.getAttribute("name");
        const fieldValue = this.value.trim();
        let table = "user"; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–∞–±–ª–∏—Ü–∞ user

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫ –∫–∞–∫–æ–π —Ç–∞–±–ª–∏—Ü–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ø–æ–ª–µ
        if (["about_me"].includes(fieldName)) {
            table = "resume"; // –ü–æ–ª—è –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ —Ç–∞–±–ª–∏—Ü–µ resume
        }
        if (["network_link"].includes(fieldName)) {
            table = "userSocialNetwork"; // –ü–æ–ª—è –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ —Ç–∞–±–ª–∏—Ü–µ resume
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑—É
        updateDataInDB(table, fieldName, fieldValue);
        alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.");
    });
});

    </script>
</html>